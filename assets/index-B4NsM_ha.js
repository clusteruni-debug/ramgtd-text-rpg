(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();function r(l,e,t){const s=document.createElement(l);return e&&(s.className=e),t&&(s.textContent=t),s}function f(l,e){return Math.floor(Math.random()*(e-l+1))+l}function g(l){return new Promise(e=>setTimeout(e,l))}function d(l){return JSON.parse(JSON.stringify(l))}function o(l,e,t){return Math.max(e,Math.min(t,l))}class _{constructor(){this._listeners={},this.state=this._createInitialState()}_createInitialState(){return{player:{name:"í”Œë ˆì´ì–´",level:1,exp:0,expToNext:100,hp:100,maxHp:100,mp:50,maxMp:50,attack:10,defense:5,speed:5},inventory:[],flags:{},currentScene:null,gold:0}}on(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}off(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(s=>s!==t))}emit(e,t){this._listeners[e]&&this._listeners[e].forEach(s=>s(t))}getStat(e){return this.state.player[e]}modifyStat(e,t){const s=this.state.player;e in s&&(s[e]+=t,e==="hp"&&(s.hp=o(s.hp,0,s.maxHp)),e==="mp"&&(s.mp=o(s.mp,0,s.maxMp)),this.emit("statChanged",{stat:e,value:s[e],delta:t}),e==="hp"&&s.hp<=0&&this.emit("playerDead",null))}setStat(e,t){const s=this.state.player;if(!(e in s))return;const a=s[e];s[e]=t,this.emit("statChanged",{stat:e,value:t,delta:t-a})}addExp(e){const t=this.state.player;for(t.exp+=e,this.emit("expGained",{amount:e,total:t.exp});t.exp>=t.expToNext;)t.exp-=t.expToNext,t.level+=1,t.expToNext=Math.floor(t.expToNext*1.5),t.maxHp+=10,t.maxMp+=5,t.hp=t.maxHp,t.mp=t.maxMp,t.attack+=2,t.defense+=1,t.speed+=1,this.emit("levelUp",{level:t.level})}addGold(e){this.state.gold+=e,this.emit("goldChanged",{gold:this.state.gold,delta:e})}addItem(e){const t=this.state.inventory.find(s=>s.id===e.id);t?t.quantity=(t.quantity||1)+(e.quantity||1):this.state.inventory.push({...e,quantity:e.quantity||1}),this.emit("inventoryChanged",{action:"add",item:e})}removeItem(e,t=1){const s=this.state.inventory.findIndex(n=>n.id===e);if(s===-1)return!1;const a=this.state.inventory[s];return a.quantity-=t,a.quantity<=0&&this.state.inventory.splice(s,1),this.emit("inventoryChanged",{action:"remove",itemId:e,quantity:t}),!0}hasItem(e){return this.state.inventory.some(t=>t.id===e)}getItem(e){return this.state.inventory.find(t=>t.id===e)||null}setFlag(e,t=!0){this.state.flags[e]=t,this.emit("flagChanged",{key:e,value:t})}getFlag(e){return this.state.flags[e]??null}hasFlag(e){return!!this.state.flags[e]}setCurrentScene(e){this.state.currentScene=e,this.emit("sceneChanged",{sceneId:e})}serialize(){return d(this.state)}deserialize(e){this.state=d(e),this.emit("stateLoaded",null)}reset(e=null){if(this.state=this._createInitialState(),e){const t=this.state.player;e.attack&&(t.attack+=e.attack),e.defense&&(t.defense+=e.defense),e.maxHp&&(t.maxHp+=e.maxHp,t.hp=t.maxHp),e.maxMp&&(t.maxMp+=e.maxMp,t.mp=t.maxMp),e.speed&&(t.speed+=e.speed)}this.emit("stateReset",null)}}class b{constructor(e,t=null){this.state=e,this.meta=t,this.scenes={},this.characters={},this.items={},this.enemies={},this.config={}}setMetaProgression(e){this.meta=e}loadScenes(e){Array.isArray(e)?e.forEach(t=>{this.scenes[t.id]=t}):Object.assign(this.scenes,e)}loadCharacters(e){Array.isArray(e)?e.forEach(t=>{this.characters[t.id]=t}):Object.assign(this.characters,e)}loadItems(e){Array.isArray(e)?e.forEach(t=>{this.items[t.id]=t}):Object.assign(this.items,e)}loadEnemies(e){Array.isArray(e)?e.forEach(t=>{this.enemies[t.id]=t}):Object.assign(this.enemies,e)}loadConfig(e){this.config=e}getScene(e){return this.scenes[e]||null}getCharacter(e){return this.characters[e]||null}getItemData(e){return this.items[e]||null}getEnemy(e){return this.enemies[e]||null}evaluateCondition(e){switch(e.type){case"hasFlag":return this.state.hasFlag(e.flag)===(e.value!==!1);case"hasItem":return this.state.hasItem(e.item);case"statGreaterThan":return this.state.getStat(e.stat)>e.value;case"statLessThan":return this.state.getStat(e.stat)<e.value;case"goldGreaterThan":return this.state.state.gold>e.value;case"runGreaterThan":return this.meta&&this.meta.data.totalRuns>e.value;case"hasUnlock":return this.meta&&this.meta.hasUnlock(e.unlock);case"hasPerk":return this.meta&&this.meta.hasPerk(e.perk);case"deathCountGreaterThan":return this.meta&&this.meta.data.totalDeaths>e.value;default:return console.warn(`ì•Œ ìˆ˜ ì—†ëŠ” ì¡°ê±´ íƒ€ì…: ${e.type}`),!0}}evaluateConditions(e){return!e||e.length===0?!0:e.every(t=>this.evaluateCondition(t))}applyEffect(e){switch(e.type){case"setFlag":this.state.setFlag(e.flag,e.value??!0);break;case"addItem":{const t=this.items[e.item];t&&this.state.addItem({...t,quantity:e.quantity||1});break}case"removeItem":this.state.removeItem(e.item,e.quantity||1);break;case"modifyStat":this.state.modifyStat(e.stat,e.value);break;case"setStat":this.state.setStat(e.stat,e.value);break;case"addExp":this.state.addExp(e.value);break;case"addGold":this.state.addGold(e.value);break;case"heal":this.state.modifyStat("hp",e.value);break;case"unlock":this.meta&&(this.meta.addUnlock(e.unlock),this.meta.save());break;case"addPerk":this.meta&&(this.meta.addPerk(e.perk,{name:e.name||e.perk,description:e.description||"",effect:e.effect||null}),this.meta.save());break;case"addPermanentBonus":this.meta&&(this.meta.addPermanentBonus(e.stat,e.value),this.meta.save());break;default:console.warn(`ì•Œ ìˆ˜ ì—†ëŠ” íš¨ê³¼ íƒ€ì…: ${e.type}`)}}applyEffects(e){!e||e.length===0||e.forEach(t=>this.applyEffect(t))}getAvailableChoices(e){return e.choices?e.choices.map(t=>({...t,available:this.evaluateConditions(t.conditions)})):[]}}class x{constructor(){this._timer=null,this._resolve=null,this._isTyping=!1,this._fullText="",this._targetElement=null,this.speed=30}get isTyping(){return this._isTyping}type(e,t){return this._isTyping&&this.skip(),this._fullText=t,this._targetElement=e,this._isTyping=!0,e.textContent="",new Promise(s=>{this._resolve=s;let a=0;this._timer=setInterval(()=>{a<t.length?(e.textContent+=t[a],a++):this._finish()},this.speed)})}skip(){this._isTyping&&(this._targetElement.textContent=this._fullText,this._finish())}_finish(){clearInterval(this._timer),this._timer=null,this._isTyping=!1,this._resolve&&(this._resolve(),this._resolve=null)}setSpeed(e){this.speed=e}destroy(){clearInterval(this._timer),this._timer=null,this._isTyping=!1,this._resolve=null}}class S{constructor(e){this.state=e,this.enemy=null,this.isActive=!1,this.turnCount=0,this.log=[],this._onUpdate=null,this._onEnd=null}start(e,t,s){this.enemy={...e,hp:e.hp,maxHp:e.hp},this.isActive=!0,this.turnCount=0,this.log=[],this._onUpdate=t,this._onEnd=s,this._addLog(`${this.enemy.name}ì´(ê°€) ë‚˜íƒ€ë‚¬ë‹¤!`),this._update()}playerAttack(){if(!this.isActive)return;const e=this.state.state.player,t=this._calculateDamage(e.attack,this.enemy.defense);if(this.enemy.hp=o(this.enemy.hp-t,0,this.enemy.maxHp),this._addLog(`${e.name}ì˜ ê³µê²©! ${this.enemy.name}ì—ê²Œ ${t} ë°ë¯¸ì§€!`),this.enemy.hp<=0){this._victory();return}this._enemyTurn()}playerSkill(){if(!this.isActive)return;const e=this.state.state.player,t=10;if(e.mp<t){this._addLog("MPê°€ ë¶€ì¡±í•˜ë‹¤!"),this._update();return}this.state.modifyStat("mp",-t);const s=this._calculateDamage(Math.floor(e.attack*1.5),this.enemy.defense);if(this.enemy.hp=o(this.enemy.hp-s,0,this.enemy.maxHp),this._addLog(`${e.name}ì˜ ê°•íƒ€! ${this.enemy.name}ì—ê²Œ ${s} ë°ë¯¸ì§€! (MP -${t})`),this.enemy.hp<=0){this._victory();return}this._enemyTurn()}playerUseItem(e){if(!this.isActive)return;const t=this.state.getItem(e);if(!t){this._addLog("ì•„ì´í…œì´ ì—†ë‹¤!"),this._update();return}if(t.effect){if(t.effect.type==="heal")this.state.modifyStat("hp",t.effect.value),this._addLog(`${t.name} ì‚¬ìš©! HPê°€ ${t.effect.value} íšŒë³µ!`);else if(t.effect.type==="mpRestore")this.state.modifyStat("mp",t.effect.value),this._addLog(`${t.name} ì‚¬ìš©! MPê°€ ${t.effect.value} íšŒë³µ!`);else if(t.effect.type==="damage"){const s=t.effect.value;this.enemy.hp=o(this.enemy.hp-s,0,this.enemy.maxHp),this._addLog(`${t.name} ì‚¬ìš©! ${this.enemy.name}ì—ê²Œ ${s} ë°ë¯¸ì§€!`)}}if(this.state.removeItem(e,1),this.enemy.hp<=0){this._victory();return}this._enemyTurn()}playerFlee(){if(!this.isActive)return;const e=this.state.state.player,t=o(40+(e.speed-this.enemy.speed)*5,20,90);f(1,100)<=t?(this._addLog("ë„ë§ì— ì„±ê³µí–ˆë‹¤!"),this.isActive=!1,this._update(),this._onEnd&&this._onEnd({victory:!1,fled:!0})):(this._addLog("ë„ë§ì— ì‹¤íŒ¨í–ˆë‹¤!"),this._enemyTurn())}_enemyTurn(){this.turnCount++;const e=this._calculateDamage(this.enemy.attack,this.state.state.player.defense);if(this.state.modifyStat("hp",-e),this._addLog(`${this.enemy.name}ì˜ ê³µê²©! ${e} ë°ë¯¸ì§€ë¥¼ ë°›ì•˜ë‹¤!`),this.state.state.player.hp<=0){this._defeat();return}this._update()}_calculateDamage(e,t){const s=Math.max(1,e-Math.floor(t/2)),a=f(-2,2);return Math.max(1,s+a)}_victory(){this._addLog(`${this.enemy.name}ì„(ë¥¼) ì“°ëŸ¬ëœ¨ë ¸ë‹¤!`),this.enemy.expReward&&(this.state.addExp(this.enemy.expReward),this._addLog(`ê²½í—˜ì¹˜ ${this.enemy.expReward} íšë“!`)),this.enemy.goldReward&&(this.state.addGold(this.enemy.goldReward),this._addLog(`ê³¨ë“œ ${this.enemy.goldReward} íšë“!`)),this.enemy.dropItem&&this._addLog(`${this.enemy.dropItem.name}ì„(ë¥¼) ì–»ì—ˆë‹¤!`),this.isActive=!1,this._update(),this._onEnd&&this._onEnd({victory:!0,enemy:this.enemy})}_defeat(){this._addLog("ì“°ëŸ¬ì¡Œë‹¤..."),this.isActive=!1,this._update(),this._onEnd&&this._onEnd({victory:!1,fled:!1})}_addLog(e){this.log.push(e)}_update(){this._onUpdate&&this._onUpdate({enemy:this.enemy,log:[...this.log],isActive:this.isActive,turnCount:this.turnCount})}getUsableItems(){return this.state.state.inventory.filter(e=>e.type==="consumable")}}const p="text_rpg_save_",h="text_rpg_autosave",u=3;class k{constructor(e,t=null){this.state=e,this.meta=t}setMetaProgression(e){this.meta=e}save(e){if(e<0||e>=u)return!1;const t={state:this.state.serialize(),runNumber:this.meta?this.meta.data.totalRuns:1,timestamp:Date.now(),version:1};try{return localStorage.setItem(p+e,JSON.stringify(t)),!0}catch(s){return console.error("ì„¸ì´ë¸Œ ì‹¤íŒ¨:",s),!1}}load(e){if(e<0||e>=u)return!1;try{const t=localStorage.getItem(p+e);if(!t)return!1;const s=JSON.parse(t);return this.state.deserialize(s.state),!0}catch(t){return console.error("ë¡œë“œ ì‹¤íŒ¨:",t),!1}}autoSave(){const e={state:this.state.serialize(),runNumber:this.meta?this.meta.data.totalRuns:1,timestamp:Date.now(),version:1};try{return localStorage.setItem(h,JSON.stringify(e)),!0}catch(t){return console.error("ì˜¤í† ì„¸ì´ë¸Œ ì‹¤íŒ¨:",t),!1}}loadAutoSave(){try{const e=localStorage.getItem(h);if(!e)return!1;const t=JSON.parse(e);return this.state.deserialize(t.state),!0}catch(e){return console.error("ì˜¤í† ì„¸ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:",e),!1}}getSlotInfo(e){try{const t=localStorage.getItem(p+e);if(!t)return null;const s=JSON.parse(t),a=s.state.player;return{slot:e,timestamp:s.timestamp,date:new Date(s.timestamp).toLocaleString("ko-KR"),playerName:a.name,level:a.level,scene:s.state.currentScene}}catch{return null}}getAllSlotInfo(){const e=[];for(let t=0;t<u;t++)e.push(this.getSlotInfo(t));return e}hasAutoSave(){return localStorage.getItem(h)!==null}getAutoSaveInfo(){try{const e=localStorage.getItem(h);if(!e)return null;const t=JSON.parse(e);return{timestamp:t.timestamp,date:new Date(t.timestamp).toLocaleString("ko-KR"),playerName:t.state.player.name,level:t.state.player.level}}catch{return null}}deleteSlot(e){localStorage.removeItem(p+e)}deleteAutoSave(){localStorage.removeItem(h)}saveMeta(){return this.meta?this.meta.save():!1}loadMeta(){return this.meta?this.meta.load():!1}static get MAX_SLOTS(){return u}}const y="text_rpg_meta";class L{constructor(){this.data=this._createInitialData()}_createInitialData(){return{totalRuns:0,totalDeaths:0,totalVictories:0,maxLevelReached:1,unlocks:{},perks:{},permanentBonuses:{attack:0,defense:0,maxHp:0,maxMp:0,speed:0}}}addUnlock(e){this.data.unlocks[e]=!0}hasUnlock(e){return!!this.data.unlocks[e]}addPerk(e,t){this.data.perks[e]={name:t.name||e,description:t.description||"",effect:t.effect||null}}hasPerk(e){return!!this.data.perks[e]}getPerk(e){return this.data.perks[e]||null}getAllPerks(){return Object.entries(this.data.perks).map(([e,t])=>({id:e,...t}))}addPermanentBonus(e,t){e in this.data.permanentBonuses&&(this.data.permanentBonuses[e]+=t)}recordDeath(e={}){this.data.totalDeaths++,this._updateMaxLevel(e.level)}recordVictory(e={}){this.data.totalVictories++,this._updateMaxLevel(e.level)}startNewRun(){this.data.totalRuns++}_updateMaxLevel(e){e&&e>this.data.maxLevelReached&&(this.data.maxLevelReached=e)}getRunBonuses(){return d(this.data.permanentBonuses)}save(){try{return localStorage.setItem(y,JSON.stringify(this.data)),!0}catch(e){return console.error("ë©”íƒ€ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:",e),!1}}load(){try{const e=localStorage.getItem(y);if(!e)return!1;const t=JSON.parse(e);return this.data={...this._createInitialData(),...t},this.data.permanentBonuses={...this._createInitialData().permanentBonuses,...t.permanentBonuses},!0}catch(e){return console.error("ë©”íƒ€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",e),!1}}serialize(){return d(this.data)}}class E{constructor(e,t){this.container=e,this.renderer=t,this._onNext=null,this._build(),this._bindEvents()}_build(){this.el=r("div","dialogue-box"),this.el.innerHTML=`
      <div class="dialogue-speaker"></div>
      <div class="dialogue-text"></div>
      <div class="dialogue-next">â–¼</div>
    `,this.speakerEl=this.el.querySelector(".dialogue-speaker"),this.textEl=this.el.querySelector(".dialogue-text"),this.nextEl=this.el.querySelector(".dialogue-next"),this.container.appendChild(this.el),this.hide()}_bindEvents(){const e=()=>{this.renderer.isTyping?this.renderer.skip():this._onNext&&this._onNext()};this.el.addEventListener("click",e),document.addEventListener("keydown",t=>{!this.el.classList.contains("hidden")&&(t.key===" "||t.key==="Enter")&&(t.preventDefault(),e())})}async showDialogue(e,t){this.show(),e?(this.speakerEl.textContent=e,this.speakerEl.classList.remove("hidden")):(this.speakerEl.textContent="",this.speakerEl.classList.add("hidden")),this.nextEl.classList.add("hidden"),await this.renderer.type(this.textEl,t),this.nextEl.classList.remove("hidden")}onNext(e){this._onNext=e}show(){this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden")}}class w{constructor(e){this.container=e,this.el=r("div","choice-buttons"),this.container.appendChild(this.el),this.hide()}showChoices(e){return this.el.innerHTML="",this.show(),new Promise(t=>{e.forEach((a,n)=>{const i=r("button","choice-btn");i.textContent=a.text,i.dataset.index=n,a.available?i.addEventListener("click",()=>{this.hide(),t(a)}):(i.classList.add("disabled"),i.disabled=!0,i.title="ì¡°ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤"),this.el.appendChild(i)});const s=a=>{const n=parseInt(a.key);if(n>=1&&n<=e.length){const i=e[n-1];i.available&&(document.removeEventListener("keydown",s),this.hide(),t(i))}};document.addEventListener("keydown",s)})}show(){this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden"),this.el.innerHTML=""}}class M{constructor(e,t){this.container=e,this.state=t,this._build(),this._subscribe(),this.update()}_build(){this.el=r("div","stats-panel"),this.el.innerHTML=`
      <div class="stat-row">
        <span class="stat-label">Lv.</span>
        <span class="stat-value level-value">1</span>
        <span class="stat-label gold-label">ğŸ’°</span>
        <span class="stat-value gold-value">0</span>
      </div>
      <div class="stat-bar-container">
        <div class="stat-bar hp-bar">
          <div class="stat-bar-fill hp-fill"></div>
          <span class="stat-bar-text hp-text">100/100</span>
        </div>
        <div class="stat-bar mp-bar">
          <div class="stat-bar-fill mp-fill"></div>
          <span class="stat-bar-text mp-text">50/50</span>
        </div>
      </div>
      <div class="stat-row exp-row">
        <div class="stat-bar exp-bar">
          <div class="stat-bar-fill exp-fill"></div>
          <span class="stat-bar-text exp-text">EXP 0/100</span>
        </div>
      </div>
    `,this.container.appendChild(this.el)}_subscribe(){this.state.on("statChanged",()=>this.update()),this.state.on("levelUp",()=>this.update()),this.state.on("goldChanged",()=>this.update()),this.state.on("expGained",()=>this.update()),this.state.on("stateLoaded",()=>this.update()),this.state.on("stateReset",()=>this.update())}update(){const e=this.state.state.player;this.el.querySelector(".level-value").textContent=e.level,this.el.querySelector(".gold-value").textContent=this.state.state.gold;const t=e.hp/e.maxHp*100;this.el.querySelector(".hp-fill").style.width=`${t}%`,this.el.querySelector(".hp-text").textContent=`HP ${e.hp}/${e.maxHp}`;const s=e.mp/e.maxMp*100;this.el.querySelector(".mp-fill").style.width=`${s}%`,this.el.querySelector(".mp-text").textContent=`MP ${e.mp}/${e.maxMp}`;const a=e.exp/e.expToNext*100;this.el.querySelector(".exp-fill").style.width=`${a}%`,this.el.querySelector(".exp-text").textContent=`EXP ${e.exp}/${e.expToNext}`}}class P{constructor(e){this.container=e,this._onAction=null,this._build(),this.hide()}_build(){this.el=r("div","combat-ui"),this.el.innerHTML=`
      <div class="combat-enemy">
        <div class="enemy-sprite"></div>
        <div class="enemy-name"></div>
        <div class="stat-bar enemy-hp-bar">
          <div class="stat-bar-fill enemy-hp-fill"></div>
          <span class="stat-bar-text enemy-hp-text"></span>
        </div>
      </div>
      <div class="combat-log"></div>
      <div class="combat-actions">
        <button class="combat-btn" data-action="attack">âš”ï¸ ê³µê²©</button>
        <button class="combat-btn" data-action="skill">âœ¨ ê°•íƒ€</button>
        <button class="combat-btn" data-action="item">ğŸ’ ì•„ì´í…œ</button>
        <button class="combat-btn" data-action="flee">ğŸƒ ë„ë§</button>
      </div>
      <div class="combat-items hidden"></div>
    `,this.enemySprite=this.el.querySelector(".enemy-sprite"),this.enemyNameEl=this.el.querySelector(".enemy-name"),this.enemyHpFill=this.el.querySelector(".enemy-hp-fill"),this.enemyHpText=this.el.querySelector(".enemy-hp-text"),this.logEl=this.el.querySelector(".combat-log"),this.actionsEl=this.el.querySelector(".combat-actions"),this.itemsEl=this.el.querySelector(".combat-items"),this.actionsEl.querySelectorAll(".combat-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;t==="item"?this._toggleItems():this._onAction&&this._onAction(t)})}),this.container.appendChild(this.el)}updateCombat(e){const{enemy:t,log:s,isActive:a}=e;if(t){this.enemyNameEl.textContent=t.name;const i=t.hp/t.maxHp*100;this.enemyHpFill.style.width=`${i}%`,this.enemyHpText.textContent=`${t.hp}/${t.maxHp}`,this.enemySprite.className=`enemy-sprite enemy-${t.sprite||"default"}`}this.logEl.innerHTML="",s.slice(-5).forEach(i=>{const c=r("div","combat-log-line",i);this.logEl.appendChild(c)}),this.logEl.scrollTop=this.logEl.scrollHeight,this.actionsEl.querySelectorAll(".combat-btn").forEach(i=>{i.disabled=!a})}showItems(e){if(this.itemsEl.innerHTML="",this.itemsEl.classList.remove("hidden"),e.length===0){this.itemsEl.innerHTML='<div class="no-items">ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œì´ ì—†ë‹¤</div>',setTimeout(()=>this.itemsEl.classList.add("hidden"),1500);return}e.forEach(s=>{const a=r("button","item-btn");a.textContent=`${s.name} x${s.quantity}`,a.addEventListener("click",()=>{this.itemsEl.classList.add("hidden"),this._onAction&&this._onAction("useItem",s.id)}),this.itemsEl.appendChild(a)});const t=r("button","item-btn item-close","ì·¨ì†Œ");t.addEventListener("click",()=>this.itemsEl.classList.add("hidden")),this.itemsEl.appendChild(t)}_toggleItems(){this.itemsEl.classList.contains("hidden")?this._onAction&&this._onAction("showItems"):this.itemsEl.classList.add("hidden")}onAction(e){this._onAction=e}show(){this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden"),this.itemsEl.classList.add("hidden")}}class I{constructor(e,t){this.container=e,this.state=t,this._onUseItem=null,this._build(),this._subscribe(),this.hide()}_build(){this.el=r("div","inventory-panel"),this.el.innerHTML=`
      <div class="inventory-header">
        <span class="inventory-title">ğŸ’ ì¸ë²¤í† ë¦¬</span>
        <button class="inventory-close">âœ•</button>
      </div>
      <div class="inventory-list"></div>
    `,this.listEl=this.el.querySelector(".inventory-list"),this.el.querySelector(".inventory-close").addEventListener("click",()=>this.hide()),this.container.appendChild(this.el)}_subscribe(){this.state.on("inventoryChanged",()=>this.update()),this.state.on("stateLoaded",()=>this.update()),this.state.on("stateReset",()=>this.update())}update(){this.listEl.innerHTML="";const e=this.state.state.inventory;if(e.length===0){this.listEl.innerHTML='<div class="inventory-empty">ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤</div>';return}e.forEach(t=>{const s=r("div","inventory-item");if(s.innerHTML=`
        <div class="item-info">
          <span class="item-name">${t.name}</span>
          <span class="item-qty">x${t.quantity}</span>
        </div>
        <div class="item-desc">${t.description||""}</div>
      `,t.type==="consumable"){const a=r("button","item-use-btn","ì‚¬ìš©");a.addEventListener("click",()=>{this._onUseItem&&this._onUseItem(t.id)}),s.appendChild(a)}this.listEl.appendChild(s)})}onUseItem(e){this._onUseItem=e}toggle(){this.el.classList.contains("hidden")?(this.update(),this.show()):this.hide()}show(){this.update(),this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden")}}class T{constructor(e,t,s=null){this.container=e,this.saveSystem=t,this.meta=s,this._onNewGame=null,this._onLoadGame=null,this._build()}_build(){this.el=r("div","title-screen"),this.el.innerHTML=`
      <div class="title-content">
        <div class="title-logo">
          <div class="title-text">TEXT RPG</div>
          <div class="title-subtitle">ì´ìƒí•œ ì•±ì´ ëœ¬ ë‚ </div>
        </div>
        <div class="title-run-info hidden"></div>
        <div class="title-menu">
          <button class="title-btn new-game-btn">&#9654; ìƒˆ ê²Œì„</button>
          <button class="title-btn continue-btn">&#9654; ì´ì–´í•˜ê¸°</button>
          <button class="title-btn perks-btn hidden">&#9733; íŠ¹ì „ ëª©ë¡</button>
        </div>
        <div class="save-slots hidden"></div>
        <div class="perks-panel hidden"></div>
        <div class="title-footer">
          <span>Space / Enterë¡œ ì„ íƒ</span>
        </div>
      </div>
    `,this.menuEl=this.el.querySelector(".title-menu"),this.slotsEl=this.el.querySelector(".save-slots"),this.continueBtn=this.el.querySelector(".continue-btn"),this.runInfoEl=this.el.querySelector(".title-run-info"),this.perksBtn=this.el.querySelector(".perks-btn"),this.perksPanel=this.el.querySelector(".perks-panel"),this.el.querySelector(".new-game-btn").addEventListener("click",()=>{this._onNewGame&&this._onNewGame()}),this.continueBtn.addEventListener("click",()=>{this._showSaveSlots()}),this.perksBtn.addEventListener("click",()=>{this._togglePerksPanel()}),this.container.appendChild(this.el)}_showSaveSlots(){this.slotsEl.innerHTML="",this.slotsEl.classList.remove("hidden"),this.perksPanel.classList.add("hidden");const e=this.saveSystem.getAutoSaveInfo();if(e){const a=r("button","slot-btn");a.innerHTML=`
        <span class="slot-label">ì˜¤í† ì„¸ì´ë¸Œ</span>
        <span class="slot-info">${e.playerName} Lv.${e.level} - ${e.date}</span>
      `,a.addEventListener("click",()=>{this.saveSystem.loadAutoSave(),this._onLoadGame&&this._onLoadGame()}),this.slotsEl.appendChild(a)}this.saveSystem.getAllSlotInfo().forEach((a,n)=>{const i=r("button","slot-btn");a?(i.innerHTML=`
          <span class="slot-label">ìŠ¬ë¡¯ ${n+1}</span>
          <span class="slot-info">${a.playerName} Lv.${a.level} - ${a.date}</span>
        `,i.addEventListener("click",()=>{this.saveSystem.load(n),this._onLoadGame&&this._onLoadGame()})):(i.innerHTML=`
          <span class="slot-label">ìŠ¬ë¡¯ ${n+1}</span>
          <span class="slot-info">â€” ë¹„ì–´ ìˆìŒ â€”</span>
        `,i.disabled=!0,i.classList.add("empty")),this.slotsEl.appendChild(i)});const s=r("button","slot-btn slot-back","â† ë’¤ë¡œ");s.addEventListener("click",()=>{this.slotsEl.classList.add("hidden")}),this.slotsEl.appendChild(s)}_togglePerksPanel(){if(!this.perksPanel.classList.contains("hidden")){this.perksPanel.classList.add("hidden");return}if(this.slotsEl.classList.add("hidden"),this.perksPanel.innerHTML="",this.perksPanel.classList.remove("hidden"),!this.meta)return;const e=this.meta.getAllPerks(),t=this.meta.data.permanentBonuses;if(e.length===0&&Object.values(t).every(a=>a===0))this.perksPanel.innerHTML=`
        <div class="perks-title">íšë“í•œ íŠ¹ì „</div>
        <div class="perks-empty">ì•„ì§ ì—†ìŒ â€” í”Œë ˆì´í•˜ë©´ì„œ í•´ê¸ˆí•˜ì„¸ìš”!</div>
      `;else{let a='<div class="perks-title">íšë“í•œ íŠ¹ì „</div>';e.forEach(i=>{a+=`<div class="perk-item"><span class="perk-name">${i.name}</span><span class="perk-desc">${i.description}</span></div>`});const n=Object.entries(t).filter(([,i])=>i>0);if(n.length>0){a+='<div class="perks-bonus-title">ì˜êµ¬ ë³´ë„ˆìŠ¤</div>';const i={attack:"ê³µê²©",defense:"ë°©ì–´",maxHp:"HP",maxMp:"MP",speed:"ì†ë„"};n.forEach(([c,v])=>{a+=`<div class="perk-bonus">+${v} ${i[c]||c}</div>`})}this.perksPanel.innerHTML=a}const s=r("button","slot-btn slot-back","â† ë‹«ê¸°");s.addEventListener("click",()=>{this.perksPanel.classList.add("hidden")}),this.perksPanel.appendChild(s)}_updateRunInfo(){if(!this.meta||this.meta.data.totalRuns===0){this.runInfoEl.classList.add("hidden"),this.perksBtn.classList.add("hidden");return}const e=this.meta.data;this.runInfoEl.innerHTML=`Run #${e.totalRuns+1} | ì‚¬ë§: ${e.totalDeaths} | ìŠ¹ë¦¬: ${e.totalVictories}`,this.runInfoEl.classList.remove("hidden"),Object.keys(e.perks).length>0||Object.values(e.permanentBonuses).some(s=>s>0)?this.perksBtn.classList.remove("hidden"):this.perksBtn.classList.add("hidden")}updateContinueButton(){const e=this.saveSystem.hasAutoSave(),t=this.saveSystem.getAllSlotInfo().some(s=>s!==null);this.continueBtn.disabled=!e&&!t,this.continueBtn.disabled&&this.continueBtn.classList.add("disabled")}onNewGame(e){this._onNewGame=e}onLoadGame(e){this._onLoadGame=e}show(){this.slotsEl.classList.add("hidden"),this.perksPanel.classList.add("hidden"),this.updateContinueButton(),this._updateRunInfo(),this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden")}}class C{constructor(e,t){this.container=e,this.saveSystem=t,this._callbacks={},this._build(),this.hide()}_build(){this.el=r("div","menu-bar"),this.el.innerHTML=`
      <button class="menu-btn" data-action="inventory" title="ì¸ë²¤í† ë¦¬">ğŸ’</button>
      <button class="menu-btn" data-action="save" title="ì„¸ì´ë¸Œ">ğŸ’¾</button>
      <button class="menu-btn" data-action="title" title="íƒ€ì´í‹€ë¡œ">ğŸ </button>
    `,this.el.querySelectorAll(".menu-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;t==="save"?this._showSaveDialog():this._callbacks[t]&&this._callbacks[t]()})}),this.saveDialog=r("div","save-dialog hidden"),this.el.appendChild(this.saveDialog),this.container.appendChild(this.el)}_showSaveDialog(){this.saveDialog.innerHTML="",this.saveDialog.classList.remove("hidden");const e=r("div","save-dialog-header","ğŸ’¾ ì„¸ì´ë¸Œ");this.saveDialog.appendChild(e);for(let s=0;s<3;s++){const a=this.saveSystem.getSlotInfo(s),n=r("button","slot-btn");a?n.innerHTML=`
          <span class="slot-label">ìŠ¬ë¡¯ ${s+1}</span>
          <span class="slot-info">${a.playerName} Lv.${a.level} - ${a.date}</span>
        `:n.innerHTML=`
          <span class="slot-label">ìŠ¬ë¡¯ ${s+1}</span>
          <span class="slot-info">â€” ë¹„ì–´ ìˆìŒ â€”</span>
        `;const i=s;n.addEventListener("click",()=>{this.saveSystem.save(i),this.saveDialog.classList.add("hidden"),this._callbacks.onSave&&this._callbacks.onSave(i)}),this.saveDialog.appendChild(n)}const t=r("button","slot-btn slot-back","â† ë‹«ê¸°");t.addEventListener("click",()=>this.saveDialog.classList.add("hidden")),this.saveDialog.appendChild(t)}on(e,t){this._callbacks[e]=t}show(){this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden")}}class ${constructor(e){this.container=e,this._onRestart=null,this._build()}_build(){this.el=r("div","death-screen hidden"),this.el.innerHTML=`
      <div class="death-content">
        <div class="death-title">ì“°ëŸ¬ì¡Œë‹¤...</div>
        <div class="death-stats"></div>
        <div class="death-rewards"></div>
        <button class="death-restart-btn">&#9654; ë‹¤ì‹œ ì‹œì‘</button>
        <div class="death-run-info"></div>
      </div>
    `,this.statsEl=this.el.querySelector(".death-stats"),this.rewardsEl=this.el.querySelector(".death-rewards"),this.runInfoEl=this.el.querySelector(".death-run-info"),this.el.querySelector(".death-restart-btn").addEventListener("click",()=>{this._onRestart&&this._onRestart()}),this.container.appendChild(this.el)}show(e={},t=[],s={}){this.statsEl.innerHTML=`
      <div class="death-stat-title">ì´ë²ˆ íšŒì°¨ ì„±ê³¼</div>
      <div class="death-stat-row">
        <span>ë„ë‹¬ ë ˆë²¨</span><span>Lv.${e.level||1}</span>
      </div>
      <div class="death-stat-row">
        <span>íšë“ ê³¨ë“œ</span><span>${e.gold||0}G</span>
      </div>
    `,t.length>0?(this.rewardsEl.innerHTML=`
        <div class="death-reward-title">ì˜êµ¬ ë³´ìƒ íšë“!</div>
        ${t.map(a=>`
          <div class="death-reward-item">${a.icon||"+"} ${a.text}</div>
        `).join("")}
      `,this.rewardsEl.classList.remove("hidden")):this.rewardsEl.innerHTML="",this.runInfoEl.textContent=`Run #${s.totalRuns||1} | ì´ ì‚¬ë§: ${s.totalDeaths||0}`,this.el.classList.remove("hidden")}hide(){this.el.classList.add("hidden")}onRestart(e){this._onRestart=e}}const H=[{id:"intro_01",type:"dialogue",background:"street",speaker:null,text:"í‰ë²”í•œ ì›”ìš”ì¼ ì•„ì¹¨. ì¶œê·¼ê¸¸ ì§€í•˜ì²  ì•ˆì—ì„œ ë©í•˜ë‹ˆ í°ì„ ë³´ê³  ìˆë‹¤.",choices:[{text:"ê³„ì†...",nextScene:"intro_02"}]},{id:"intro_02",type:"dialogue",background:"subway",speaker:null,text:"ê°‘ìê¸° í°ì´ ì§„ë™í•œë‹¤. í™”ë©´ì— ë³¸ ì  ì—†ëŠ” ì•±ì´ ë–  ìˆë‹¤. 'ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë°”ê¿€ ê¸°íšŒ â€” íƒ­í•˜ì—¬ ì‹œì‘'",choices:[{text:"ì•±ì„ íƒ­í•œë‹¤",effects:[{type:"setFlag",flag:"opened_app"},{type:"addItem",item:"mystery_phone"}],nextScene:"app_open"},{text:"ë¬´ì‹œí•˜ê³  ì¶œê·¼í•œë‹¤",effects:[{type:"setFlag",flag:"ignored_app"}],nextScene:"ignore_app"},{text:"...ì´ ì•±, ì „ì—ë„ ë³¸ ì  ìˆë‹¤ (ìˆ¨ê²¨ì§„ ë£¨íŠ¸)",conditions:[{type:"runGreaterThan",value:1}],effects:[{type:"setFlag",flag:"opened_app"},{type:"setFlag",flag:"deja_vu"},{type:"addItem",item:"mystery_phone"},{type:"unlock",unlock:"secret_path"}],nextScene:"deja_vu_route"}]},{id:"deja_vu_route",type:"dialogue",background:"glitch",speaker:"???",text:"...ë‹¹ì‹ , ê¸°ì–µí•˜ê³  ìˆêµ°ìš”. ì´ì „ì˜ ê¸°ì–µì´... ì´ê±´ ì²˜ìŒì´ì—ìš”. ì¢‹ì•„ìš”, íŠ¹ë³„í•œ ê±¸ ë³´ì—¬ë“œë¦¬ì£ .",effects:[{type:"addPermanentBonus",stat:"speed",value:1},{type:"addExp",value:30}],choices:[{text:"ë­˜ ë³´ì—¬ì¤„ ê±´ë°?",nextScene:"app_open_02"}]},{id:"app_open",type:"dialogue",background:"glitch",speaker:"???",text:"ì¶•í•˜í•©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì„ íƒë°›ì•˜ìŠµë‹ˆë‹¤. ì´ì œë¶€í„° ë‹¹ì‹ ì˜ í•˜ë£¨ëŠ”... ì¡°ê¸ˆ ë‹¬ë¼ì§ˆ ê²ë‹ˆë‹¤.",choices:[{text:"ë­... ë­ì•¼?",nextScene:"app_open_02"}]},{id:"app_open_02",type:"dialogue",background:"office",speaker:null,text:"ì •ì‹ ì„ ì°¨ë ¤ë³´ë‹ˆ ì–´ëŠìƒˆ íšŒì‚¬ì— ë„ì°©í•´ ìˆë‹¤. ë¨¸ë¦¬ê°€ ì•½ê°„ ì–´ì§€ëŸ½ë‹¤. ì±…ìƒ ìœ„ì— ì»¤í”¼ê°€ ë†“ì—¬ ìˆë‹¤.",effects:[{type:"addItem",item:"coffee"}],choices:[{text:"ì»¤í”¼ë¥¼ ë§ˆì‹ ë‹¤",effects:[{type:"modifyStat",stat:"hp",value:10},{type:"setFlag",flag:"drank_coffee"}],nextScene:"office_01"},{text:"ì¼ë¶€í„° ì‹œì‘í•œë‹¤",nextScene:"office_01"}]},{id:"ignore_app",type:"dialogue",background:"office",speaker:null,text:"ë³„ ê±° ì•„ë‹ˆê² ì§€. ë¬´ì‹œí•˜ê³  ì¶œê·¼í–ˆë‹¤. íšŒì‚¬ì— ë„ì°©í•˜ë‹ˆ ì´ëŒ€ë¦¬ê°€ ì†ì„ í”ë“ ë‹¤.",choices:[{text:"ì¸ì‚¬í•œë‹¤",nextScene:"colleague_chat"}]},{id:"colleague_chat",type:"dialogue",background:"office",speaker:"ì´ëŒ€ë¦¬",text:"ì•¼, ì˜¤ëŠ˜ ë¶€ì¥ë‹˜ ê¸°ë¶„ì´ ë³„ë¡œì•¼. ì¡°ì‹¬í•´. ì•„, ê·¸ë¦¬ê³  ì´ê±° ë¨¹ì–´.",effects:[{type:"addItem",item:"lunch_box"},{type:"setFlag",flag:"talked_to_colleague"}],choices:[{text:"ê³ ë§™ë‹¤! (ë„ì‹œë½ íšë“)",nextScene:"office_01"}]},{id:"office_01",type:"dialogue",background:"office",speaker:"ë°•ë¶€ì¥",text:"ê¹€ì§ì¥!! ë³´ê³ ì„œëŠ”?! ì•„ì§ë„ ì•ˆ í–ˆì–´?!",choices:[{text:"ì£„ì†¡í•©ë‹ˆë‹¤, ë°”ë¡œ í•˜ê² ìŠµë‹ˆë‹¤ (ìˆœì¢…)",effects:[{type:"modifyStat",stat:"hp",value:-5},{type:"setFlag",flag:"obeyed_boss"}],nextScene:"obey_ending"},{text:"...ì˜¤ëŠ˜ì€ ì°¸ì§€ ì•Šê² ë‹¤ (ëŒ€í•­)",conditions:[{type:"hasFlag",flag:"opened_app",value:!0}],effects:[{type:"setFlag",flag:"confronted_boss"}],nextScene:"boss_battle"},{text:"...ì˜¤ëŠ˜ì€ ì°¸ì§€ ì•Šê² ë‹¤ (ëŒ€í•­)",conditions:[{type:"hasFlag",flag:"ignored_app",value:!0}],nextScene:"boss_battle"},{text:"ë¶€ì¥ë‹˜, ì‚¬ì‹¤ ë“œë¦´ ë§ì”€ì´... (3íšŒì°¨ ì´ìƒ í•´ê¸ˆ)",conditions:[{type:"runGreaterThan",value:2}],effects:[{type:"setFlag",flag:"negotiated_boss"}],nextScene:"negotiate_boss"},{text:"[ì´ë¯¸ 5ë²ˆì´ë‚˜ ì¡Œì–ì•„...] ì´ë²ˆì—” ë‹¤ë¥´ë‹¤!",conditions:[{type:"deathCountGreaterThan",value:4}],effects:[{type:"setFlag",flag:"confronted_boss"},{type:"modifyStat",stat:"attack",value:5}],nextScene:"boss_battle"}]},{id:"negotiate_boss",type:"dialogue",background:"office",speaker:"ë°•ë¶€ì¥",text:"...ë­? í˜‘ìƒì´ë¼ê³ ? í¥, ë„¤ê°€ ë¬´ìŠ¨ í˜‘ìƒì„...",choices:[{text:"ë³´ê³ ì„œ ëŒ€ì‹  í”„ë ˆì  í…Œì´ì…˜ì„ í•˜ê² ìŠµë‹ˆë‹¤",effects:[{type:"addExp",value:50},{type:"unlock",unlock:"negotiator"},{type:"addPerk",perk:"silver_tongue",name:"ì€ë¹› í˜€",description:"í˜‘ìƒìœ¼ë¡œ ìœ„ê¸°ë¥¼ ë„˜ê¸´ ê²½í—˜"}],nextScene:"negotiate_ending"},{text:"ì—­ì‹œ ì•ˆ ë˜ê² êµ°... ì‹¸ìš°ì!",nextScene:"boss_battle"}]},{id:"negotiate_ending",type:"ending",background:"office_sunset",speaker:null,text:"ë†€ëê²Œë„, ë°•ë¶€ì¥ì´ ê³ ê°œë¥¼ ë„ë•ì˜€ë‹¤. í”„ë ˆì  í…Œì´ì…˜ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ ëŒ€ì²´í•˜ê¸°ë¡œ í–ˆë‹¤. íšŒì‚¬ ìƒí™œì—ë„ ë‹¤ì–‘í•œ ê¸¸ì´ ìˆë‹¤ëŠ” ê±¸ ê¹¨ë‹¬ì•˜ë‹¤.",endingType:"victory",effects:[{type:"addPermanentBonus",stat:"defense",value:1}],choices:[{text:"ğŸ® íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°",nextScene:"__title__"}]},{id:"boss_battle",type:"combat",background:"office_battle",enemy:"angry_boss",introText:"ë°•ë¶€ì¥ì´ ë¶„ë…¸ë¡œ ì´ê¸€ì´ê¸€ íƒ€ì˜¤ë¥´ê³  ìˆë‹¤! ì„¤ì „ì´ ì‹œì‘ëœë‹¤!",victoryScene:"victory_ending",defeatScene:"defeat_ending",fleeScene:"obey_ending"},{id:"victory_ending",type:"ending",background:"office_sunset",speaker:null,text:"ë°•ë¶€ì¥ì„ ì„¤ì „ìœ¼ë¡œ ì´ê²¼ë‹¤! ì‚¬ë¬´ì‹¤ì´ ì¡°ìš©í•´ì¡Œë‹¤. ì´ëŒ€ë¦¬ê°€ ì—„ì§€ë¥¼ ì¹˜ì¼œì„¸ìš´ë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ê°€ ë­”ê°€ ë‹¬ë¼ì§„ ê¸°ë¶„ì´ë‹¤.",endingType:"victory",choices:[{text:"ğŸ® íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°",nextScene:"__title__"}]},{id:"defeat_ending",type:"ending",background:"office_dark",speaker:null,text:"ë°•ë¶€ì¥ì˜ ì”ì†Œë¦¬ì— ê²°êµ­ ë¬´ë¦ì„ ê¿‡ì—ˆë‹¤... ì˜¤ëŠ˜ë„ ì•¼ê·¼ì´ë‹¤.",endingType:"defeat",choices:[{text:"...ë‹¤ì‹œ í•œë²ˆ (ì‚¬ë§ ì²˜ë¦¬)",nextScene:"__death__"},{text:"ğŸ® íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°",nextScene:"__title__"}]},{id:"obey_ending",type:"ending",background:"office_night",speaker:null,text:"ìˆœìˆœíˆ ë³´ê³ ì„œë¥¼ ì‘ì„±í–ˆë‹¤. í‰ë²”í•œ í•˜ë£¨ê°€ ëë‚¬ë‹¤. í•˜ì§€ë§Œ í° ì† ì•±ì€ ì—¬ì „íˆ ê¹œë¹¡ì´ê³  ìˆë‹¤...",endingType:"normal",choices:[{text:"ğŸ® íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°",nextScene:"__title__"}]}],A=[{id:"player",name:"ê¹€ì§ì¥",description:"í‰ë²”í•œ íšŒì‚¬ì›. ì˜¤ëŠ˜ë„ ì¶œê·¼ ì¤‘."},{id:"narrator",name:null,description:"ë‚˜ë ˆì´í„°"},{id:"boss",name:"ë°•ë¶€ì¥",description:"í•­ìƒ í™”ê°€ ë‚œ ë¶€ì¥ë‹˜"},{id:"colleague",name:"ì´ëŒ€ë¦¬",description:"ê°™ì€ íŒ€ ë™ë£Œ. ì˜ì™¸ë¡œ ë„ì›€ì´ ëœë‹¤."},{id:"mysterious_app",name:"???",description:"ì •ì²´ë¶ˆëª…ì˜ ì•± ì•Œë¦¼"}],B=[{id:"coffee",name:"ì»¤í”¼",description:"ë”°ëœ»í•œ ì•„ë©”ë¦¬ì¹´ë…¸. HPë¥¼ 30 íšŒë³µí•œë‹¤.",type:"consumable",effect:{type:"heal",value:30}},{id:"energy_drink",name:"ì—ë„ˆì§€ ë“œë§í¬",description:"MPë¥¼ 20 íšŒë³µí•œë‹¤.",type:"consumable",effect:{type:"mpRestore",value:20}},{id:"lunch_box",name:"ë„ì‹œë½",description:"ì—„ë§ˆê°€ ì‹¸ì¤€ ë„ì‹œë½. HPë¥¼ 50 íšŒë³µí•œë‹¤.",type:"consumable",effect:{type:"heal",value:50}},{id:"mystery_phone",name:"ì´ìƒí•œ ì•±",description:"í°ì— ê°‘ìê¸° ë‚˜íƒ€ë‚œ ì•±. ì •ì²´ë¥¼ ì•Œ ìˆ˜ ì—†ë‹¤.",type:"key",effect:null},{id:"report",name:"ë³´ê³ ì„œ",description:"ê¸‰í•˜ê²Œ ë§Œë“  ë³´ê³ ì„œ. ê³µê²©ë ¥ì´ 5 ì˜¤ë¥¼ì§€ë„?",type:"equipment",effect:{type:"modifyStat",stat:"attack",value:5}}],N=[{id:"angry_boss",name:"ë¶„ë…¸í•œ ë°•ë¶€ì¥",sprite:"boss",hp:80,attack:12,defense:4,speed:3,expReward:50,goldReward:100,dropItem:{id:"coffee",name:"ì»¤í”¼",description:"ë”°ëœ»í•œ ì•„ë©”ë¦¬ì¹´ë…¸. HPë¥¼ 30 íšŒë³µí•œë‹¤.",type:"consumable",effect:{type:"heal",value:30}},skills:[]}],q="ì´ìƒí•œ ì•±ì´ ëœ¬ ë‚ ",R="0.1.0",D="intro_01",G=30,U={name:"ê¹€ì§ì¥",level:1,hp:100,maxHp:100,mp:50,maxMp:50,attack:10,defense:5,speed:5},m={title:q,version:R,startScene:D,typingSpeed:G,initialStats:U};class O{constructor(e){this.app=e,this.metaProgression=new L,this.metaProgression.load(),this.stateManager=new _,this.sceneManager=new b(this.stateManager,this.metaProgression),this.dialogueRenderer=new x,this.combatSystem=new S(this.stateManager),this.saveLoadSystem=new k(this.stateManager,this.metaProgression),this.sceneManager.loadScenes(H),this.sceneManager.loadCharacters(A),this.sceneManager.loadItems(B),this.sceneManager.loadEnemies(N),this.sceneManager.loadConfig(m),this.dialogueRenderer.setSpeed(m.typingSpeed||30),this._buildUI(),this._bindEvents(),this.showTitle()}_buildUI(){this.bgEl=r("div","game-background"),this.app.appendChild(this.bgEl),this.gameContainer=r("div","game-container"),this.app.appendChild(this.gameContainer),this.titleScreen=new T(this.app,this.saveLoadSystem,this.metaProgression),this.statsPanel=new M(this.app,this.stateManager),this.menuBar=new C(this.app,this.saveLoadSystem),this.dialogueBox=new E(this.app,this.dialogueRenderer),this.choiceButtons=new w(this.app),this.combatUI=new P(this.app),this.inventoryPanel=new I(this.app,this.stateManager),this.deathScreen=new $(this.app)}_bindEvents(){this.titleScreen.onNewGame(()=>this.startNewGame()),this.titleScreen.onLoadGame(()=>this.resumeGame()),this.deathScreen.onRestart(()=>this._startNewRun()),this.menuBar.on("inventory",()=>this.inventoryPanel.toggle()),this.menuBar.on("title",()=>this.showTitle()),this.menuBar.on("onSave",e=>this.showToast(`ìŠ¬ë¡¯ ${e+1}ì— ì„¸ì´ë¸Œ ì™„ë£Œ!`,"success")),this.inventoryPanel.onUseItem(e=>{const t=this.stateManager.getItem(e);!t||t.type!=="consumable"||(t.effect&&this.sceneManager.applyEffect(t.effect),this.stateManager.removeItem(e,1),this.showToast(`${t.name} ì‚¬ìš©!`,"success"))}),this.combatUI.onAction((e,t)=>{switch(e){case"attack":this.combatSystem.playerAttack();break;case"skill":this.combatSystem.playerSkill();break;case"flee":this.combatSystem.playerFlee();break;case"showItems":this.combatUI.showItems(this.combatSystem.getUsableItems());break;case"useItem":this.combatSystem.playerUseItem(t);break}}),this.stateManager.on("levelUp",({level:e})=>{this.showToast(`ë ˆë²¨ ì—…! Lv.${e}`,"success"),this.app.classList.add("level-up-flash"),setTimeout(()=>this.app.classList.remove("level-up-flash"),800)})}showTitle(){this.combatUI.hide(),this.dialogueBox.hide(),this.choiceButtons.hide(),this.deathScreen.hide(),this.statsPanel.el.classList.add("hidden"),this.menuBar.hide(),this.inventoryPanel.hide(),this.bgEl.className="game-background",this.titleScreen.show()}startNewGame(){this.metaProgression.startNewRun(),this.metaProgression.save();const e=this.metaProgression.getRunBonuses();this.stateManager.reset(e);const t=m;if(t.initialStats){const s=this.stateManager.state.player;s.name=t.initialStats.name||s.name,s.level=t.initialStats.level||s.level,s.maxHp=(t.initialStats.maxHp||100)+e.maxHp,s.hp=s.maxHp,s.maxMp=(t.initialStats.maxMp||50)+e.maxMp,s.mp=s.maxMp,s.attack=(t.initialStats.attack||10)+e.attack,s.defense=(t.initialStats.defense||5)+e.defense,s.speed=(t.initialStats.speed||5)+e.speed}this.titleScreen.hide(),this.deathScreen.hide(),this.statsPanel.el.classList.remove("hidden"),this.statsPanel.update(),this.menuBar.show(),this.playScene(t.startScene)}resumeGame(){this.titleScreen.hide(),this.deathScreen.hide(),this.statsPanel.el.classList.remove("hidden"),this.statsPanel.update(),this.menuBar.show();const e=this.stateManager.state.currentScene;e?this.playScene(e):this.playScene(m.startScene)}_handleDeath(){const t={level:this.stateManager.state.player.level,gold:this.stateManager.state.gold};this.metaProgression.recordDeath(t);const s=[],a=this.metaProgression.data.totalDeaths;a===3&&!this.metaProgression.hasPerk("resilient")&&(this.metaProgression.addPerk("resilient",{name:"ë¶ˆêµ´ì˜ ì˜ì§€",description:"ì—¬ëŸ¬ ë²ˆì˜ íŒ¨ë°°ë¡œ ë‹¨ë ¨ë¨"}),this.metaProgression.addPermanentBonus("attack",2),s.push({icon:"ğŸ’ª",text:"ë¶ˆêµ´ì˜ ì˜ì§€ â€” ê³µê²©ë ¥ +2 (ì˜êµ¬)"})),a===5&&!this.metaProgression.hasPerk("thick_skin")&&(this.metaProgression.addPerk("thick_skin",{name:"ë‘êº¼ìš´ í”¼ë¶€",description:"ìˆ˜ë§ì€ íŒ¨ë°°ê°€ ë°©ì–´ë ¥ì„ ë†’ì˜€ë‹¤"}),this.metaProgression.addPermanentBonus("defense",2),s.push({icon:"ğŸ›¡ï¸",text:"ë‘êº¼ìš´ í”¼ë¶€ â€” ë°©ì–´ë ¥ +2 (ì˜êµ¬)"})),this.metaProgression.data.permanentBonuses.maxHp<50&&(this.metaProgression.addPermanentBonus("maxHp",5),s.push({icon:"â¤ï¸",text:"ìƒì¡´ ë³¸ëŠ¥ â€” ìµœëŒ€ HP +5 (ì˜êµ¬)"})),this.metaProgression.save(),this.combatUI.hide(),this.dialogueBox.hide(),this.choiceButtons.hide(),this.statsPanel.el.classList.add("hidden"),this.menuBar.hide(),this._setBackground("glitch"),this.deathScreen.show(t,s,this.metaProgression.serialize())}_startNewRun(){this.deathScreen.hide(),this.startNewGame()}_handleVictoryEnding(){const e=this.stateManager.state.player;this.metaProgression.recordVictory({level:e.level}),this.metaProgression.save()}async playScene(e){if(e==="__title__"){this.showTitle();return}if(e==="__death__"){this._handleDeath();return}const t=this.sceneManager.getScene(e);if(!t){console.error(`ì”¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${e}`);return}switch(this.stateManager.setCurrentScene(e),this.saveLoadSystem.autoSave(),this._setBackground(t.background),t.effects&&this.sceneManager.applyEffects(t.effects),t.type==="ending"&&t.endingType==="victory"&&this._handleVictoryEnding(),t.type){case"dialogue":case"ending":await this._playDialogueScene(t);break;case"combat":await this._playCombatScene(t);break;default:await this._playDialogueScene(t)}}async _playDialogueScene(e){this.combatUI.hide();let t=e.speaker;t&&this.sceneManager.getCharacter(t)&&(t=this.sceneManager.getCharacter(t).name),await this.dialogueBox.showDialogue(t,e.text);const s=this.sceneManager.getAvailableChoices(e);if(s.length===0)return;if(s.length===1&&!s[0].conditions)return new Promise(n=>{this.dialogueBox.onNext(()=>{this.dialogueBox.onNext(null);const i=s[0];i.effects&&this.sceneManager.applyEffects(i.effects),n(),i.nextScene&&this.playScene(i.nextScene)})});this.dialogueBox.onNext(null);const a=await this.choiceButtons.showChoices(s);a.effects&&this.sceneManager.applyEffects(a.effects),a.nextScene&&this.playScene(a.nextScene)}async _playCombatScene(e){this.dialogueBox.hide(),this.choiceButtons.hide();const t=d(this.sceneManager.getEnemy(e.enemy));if(!t){console.error(`ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${e.enemy}`);return}return e.introText&&(await this.dialogueBox.showDialogue(null,e.introText),await g(500),this.dialogueBox.hide()),this.combatUI.show(),new Promise(s=>{this.combatSystem.start(t,a=>{this.combatUI.updateCombat(a)},async a=>{await g(1e3),this.combatUI.hide(),a.victory&&t.dropItem&&this.stateManager.addItem({...t.dropItem,quantity:1}),a.victory&&e.victoryScene?this.playScene(e.victoryScene):a.fled&&e.fleeScene?this.playScene(e.fleeScene):!a.victory&&!a.fled&&this._handleDeath(),s()})})}_setBackground(e){e&&(this.bgEl.className=`game-background bg-${e}`,this.bgEl.classList.add("scene-transition"),setTimeout(()=>this.bgEl.classList.remove("scene-transition"),600))}showToast(e,t=""){const s=r("div",`toast ${t}`,e);this.app.appendChild(s),setTimeout(()=>s.remove(),2100)}}const F=document.querySelector("#app");new O(F);
